kind: pipeline
type: docker
name: default
platform:
  os: linux
  arch: arm64

steps:
  - name: build
    image: gitea.local/devops/dind-drone-plugin
    environment:
      CI_WORKSPACE: "/drone/src"
    settings:
      cmd: ./gradlew --info build && cp ./build/quarkus-app/quarkus-run.jar ./docker
      build_image: gitea.local/devops/jdk
      image_aliases:
        gitea.local/devops/mysql:8: mysql:8
    volumes:
      - name: dockersock
        path: /var/run
  - name: publish
    image: plugins/docker
    settings:
      registry: gitea.local
      username: duanyuepeng
      password:
        from_secret: gitea_password
      context: docker
      dockerfile: docker/Dockerfile
      repo: gitea.local/uni-sales/backend
      auto_tag: true
      auto_tag_suffix: arm64v8

services:
  - name: docker
    image: docker:dind
    privileged: true
    volumes:
      - name: dockersock
        path: /var/run

volumes:
  - name: dockersock
    temp: { }

