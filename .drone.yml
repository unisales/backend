kind: pipeline
type: docker
name: default
platform:
  os: linux
  arch: arm64

steps:
  - name: build
    image: quay.io/testcontainers/dind-drone-plugin
    environment:
      CI_WORKSPACE: "/drone/src"
    settings:
      cmd: gradle build && cp ./build/quarkus-app/quarkus-run.jar ./docker
      build_image: gradle:jdk17
      prefetch_images:
        - "mysql:8"
      image_aliases:
        gitea.local/duanyuepeng/mysql:8: mysql:8
    volumes:
      - name: dockersock
        path: /var/run
  - name: publish
    image: plugins/docker
    settings:
      registry: gitea.local
      username: duanyuepeng
      password:
        from_secret: gitea_password
      context: docker
      dockerfile: docker/Dockerfile
      repo: gitea.local/duanyuepeng/uni-sales-backend
      auto_tag: true
      auto_tag_suffix: arm64v8

services:
  - name: docker
    image: docker:dind
    privileged: true
    volumes:
      - name: dockersock
        path: /var/run

volumes:
  - name: dockersock
    temp: { }

